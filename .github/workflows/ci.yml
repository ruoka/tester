name: C/C++ CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    strategy:
      matrix:
        include:
          - config: debug
            cxxflags: "-O0 -g3"
          - config: release
            cxxflags: "-O3 -DNDEBUG"

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Setup LLVM (shared)
        uses: ./.github/actions/setup-llvm

      - name: Show compilers
        run: |
          clang --version || true
          g++ --version || true

      - name: Build project (${{ matrix.config }})
        env:
          CXXFLAGS: ${{ matrix.cxxflags }}
        run: ./tools/CB.sh ${{ matrix.config }} build

      - name: Run tests with JSONL output (${{ matrix.config }})
        run: ./tools/CB.sh ${{ matrix.config }} test --output=jsonl > test_results_${{ matrix.config }}.jsonl

      - name: Validate JSONL output
        run: |
          if [ ! -f "test_results_${{ matrix.config }}.jsonl" ]; then
            echo "ERROR: JSONL output file not found!"
            exit 1
          fi
          line_count=$(wc -l < "test_results_${{ matrix.config }}.jsonl")
          echo "JSONL lines: $line_count"
          if command -v jq >/dev/null 2>&1; then
            echo "Validating JSONL structure..."
            jq -r '.type' "test_results_${{ matrix.config }}.jsonl" | head -10
            last_line=$(tail -1 "test_results_${{ matrix.config }}.jsonl")
            if echo "$last_line" | jq -e '.type == "eof"' >/dev/null 2>&1; then
              echo "✓ EOF marker found"
            else
              echo "✗ EOF marker missing!"
              exit 1
            fi
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.config }}
          path: test_results_${{ matrix.config }}.jsonl

  test-examples:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Setup LLVM (for examples)
        uses: ./.github/actions/setup-llvm

      - name: Build project with examples
        run: ./tools/CB.sh debug --include-examples build

      - name: Run tests with examples (expect failures)
        run: |
          ./tools/CB.sh debug --include-examples test --output=jsonl > test_results_examples.jsonl || true

      - name: Verify expected failures
        run: |
          if command -v jq >/dev/null 2>&1; then
            passed=$(jq -r 'select(.type == "result") | .passed' "test_results_examples.jsonl" | head -1)
            if [ "$passed" = "false" ]; then
              echo "✓ Examples failed as expected"
              jq 'select(.type == "result")' "test_results_examples.jsonl"
            else
              echo "⚠ Unexpected: Examples passed (they should fail to demonstrate failure scenarios)"
            fi
          fi

      - name: Upload example test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-examples
          path: test_results_examples.jsonl

  static-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Setup LLVM + analysis tools
        uses: ./.github/actions/setup-llvm
        with:
          packages: "clang-20 clang-tools-20 clang-tidy-20 cppcheck"

      - name: Run clang-tidy on core files
        run: |
          find tester -name "*.c++m" | head -10 | xargs -I {} sh -c '
            echo "Analyzing {}"
            clang-tidy-20 {} -- -std=c++23 -I/usr/lib/llvm-20/include/c++/v1 2>/dev/null || true
          '

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --std=c++23 --language=c++ \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --inline-suppr \
            --quiet \
            tester/ tools/ 2>/dev/null || true

  submodule-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Check submodule status
        run: |
          echo "=== Submodule Status ==="
          git submodule status || echo "No submodules"
          echo ""
          echo "=== Checking for uncommitted changes ==="
          if git status --porcelain | grep -q .; then
            echo "✗ Uncommitted changes found in main repo"
            git status --porcelain
            exit 1
          else
            echo "✓ Main repo is clean"
          fi
